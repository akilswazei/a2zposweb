// <!--  -->
/**

 * @author Ravi Sanchaniya

 */

jQuery(document).ready(function () {
  jQuery("#read_barcode_POS").focus();

  jQuery(document).on("click", ".read_barcode_POS_submit", function (e) {
    $(function () {
      var e = $.Event("keypress");
      e.which = 13;
      $("#read_barcode_POS").trigger(e);
    });
  });

  jQuery(document).on("keypress", "#read_barcode_POS", function (e) {
    // if(e.which == 13) {
    // alert('You pressed enter!');
    // }
    var myObj = $(this);
    var barcode = $(this).val();
    // alert(base_url);
    $(".table-container").scrollTop($(".table-container")[0].scrollHeight);
    $(".table-container").scrollTop($(".table-container")[0].scrollHeight);
    var out = document.getElementsByClassName("table-container");
    var isScrolledToBottom =
      out.scrollHeight - out.clientHeight <= out.scrollTop + 1;
    if (isScrolledToBottom) out.scrollTop = out.scrollHeight - out.clientHeight;
    if (barcode != "" && e.which == 13) {
      jQuery
        .ajax({
          type: "POST",

          dataType: "json",

          url: base_url + "cashier/scanUPC_POS",

          data: { barcode: barcode },
        })
        .done(function (data) {
          console.log(data);

          if (data.status == 0) {
            // alert("Item not found");
            // swal("Oops!", 'Item not found', "error");
            // swal({
            //   title: "Oops!",
            //   text: "Item not found..!",
            //   icon: "warning",
            //   buttons: {
            //   catch: {
            //     text: "Add Product",
            //     value: "catch",
            //   },
            //   cancel: "Cancel",
              
            //   //defeat: true,
            //   },
            //   buttons: true,
            //   dangerMode: false,
            // })
            // .then((value) => {
            //   switch (value) {
             
            //     // case "defeat":
            //     //   //swal("Pikachu fainted! You gained 500 XP!");
            //     //   break;
             
            //     case "catch":
            //       window.location.href = base_url+"cashier/inventoryadd?upc="+barcode;
            //       //swal("Gotcha!", "Pikachu was caught!", "success");
            //       break;
             
            //     default:
            //       //swal("Got away safely!");
            //   }
            // });

            swal({
            title: "Oops!",
            text: "Item not found.",
            icon: "warning", 
            buttons: {
              catch: {
                text: "New Product",
                value: "catch",
              },
              custom: {
                text: "Custom Product",
                value: "custom",
              },
              cancel: "Cancel",
              
              //defeat: true,
            },
        })
        .then((value) => {
          switch (value) {
         
            // case "defeat":
            //   //swal("Pikachu fainted! You gained 500 XP!");
            //   break;
         
            case "catch":
              window.location.href = base_url+"cashier/inventoryadd?upc="+barcode;
              break;

            case "custom":
              swal.close();
              $("a[href='#epa']").trigger("click");
              break;
         
            default:
              //swal("Got away safely!");
          }
        });

            myObj.val("");
            return false;
          } else {
            if ($("#is_transaction_completed").val() == 1) {
              clearTransaction();
            }

            if (typeof data.pos_coupon_details.coupon_name != "undefined") {
              $(".coupon_details")
                .html(
                  '<p style="color:red;">' +
                    data.pos_coupon_details.coupon_name +
                    " - " +
                    data.pos_coupon_details.coupon_details +
                    "</p>"
                )
                .show();
              setTimeout(function () {
                $(".coupon_details").hide();
              }, 5000);
            }

            var exist_product_id_arr = $("#exist_product_id").val().split(",");
            if (jQuery.inArray(data.product_id, exist_product_id_arr) !== -1) {
              // Exist

              var product_id = data.product_id;
              var quantity = $("#quantity_input_" + product_id).val();
              var existing_crv = $("#product_crv_" + product_id).val();

              var org_price = $("#quantity_input_" + product_id).attr(
                "data-org_price"
              );
              quantity++;
              $("#quantity_input_" + product_id).val(quantity);

              var new_sale_price = parseFloat(org_price) * parseFloat(quantity);
              $(".onsale_price_" + product_id).html(new_sale_price.toFixed(2));
              $("#product_price_" + product_id).val(new_sale_price.toFixed(2));
              $("#product_qty_" + product_id).val(quantity);

              //ST - add crv if applicable
              var crv_oz = 0;
              var crv_rate = 0;
              var crv_price = 0;
              if (data.Applicable_CRV == 1) {
                var str2 = "oz";
                if (data.size.indexOf(str2) != -1) {
                  data.size = data.size.replace("oz", "");
                  data.size = data.size.replace(" ", "");

                  crv_oz = parseFloat(data.size);
                  if (crv_oz >= 23.99) {
                    crv_price = 0.1 * quantity;
                  } else {
                    crv_price = 0.05 * quantity;
                  }
                }
              }
              $("#product_crv_" + product_id).val(parseFloat(crv_price));

              //EN - add crv if applicable

              // ST - For Calculate Total
              calculatePOSTotal();
              // EN - For Calculate Total
            } else {
              //ST - add crv if applicable
              var crv_oz = 0;
              var crv_rate = 0;
              var crv_price = 0;
              var size_org = data.size;
              if (data.Applicable_CRV == 1) {
                var str2 = "oz";
                if (data.size.indexOf(str2) != -1) {
                  data.size = data.size.replace("oz", "");
                  data.size = data.size.replace(" ", "");
                  $("#product_crv_" + product_id).val(parseFloat(data.size));
                  crv_oz = parseFloat(data.size);
                  if (crv_oz >= 23.99) {
                    crv_price = 0.1;
                  } else {
                    crv_price = 0.05;
                  }
                }
              }
              //EN - add crv if applicable

              var item_info = "";
              item_info += "<tr id='product_tr_" + data.product_id + "'>";
              item_info +=
                '<td style="text-align: left;padding-left: 7px;">' +
                data.product_name +
                "</td>";
              item_info +=
                '<input type="hidden" name="product_id[]" value="' +
                data.product_id +
                '">';
              item_info +=
                '<input type="hidden" name="product_name[]" value="' +
                data.product_name +
                '">';
              item_info +=
                '<input type="hidden" name="product_rate[]" value="' +
                data.onsale_price +
                '">';
              item_info +=
                '<input type="hidden" id="product_price_' +
                data.product_id +
                '" name="product_price[]" value="' +
                data.onsale_price +
                '">';

              item_info +=
                '<input type="hidden" id="product_offer_price_' +
                data.product_id +
                '" name="product_offer_price[]" value="' +
                data.price +
                '">';

              item_info +=
                '<input type="hidden" id="product_qty_' +
                data.product_id +
                '" name="product_qty[]" value="1">';

              item_info +=
                '<input type="hidden" id="product_crv_' +
                data.product_id +
                '" name="product_crv[]" value="' +
                parseFloat(crv_price) +
                '">';

              item_info +=
                '<input type="hidden" id="is_product_crv_' +
                data.product_id +
                '" name="is_product_crv[]" value="' +
                data.Applicable_CRV +
                '">';

              item_info +=
                '<input type="hidden" id="is_product_size_' +
                data.product_id +
                '" name="is_product_size[]" value="' +
                size_org +
                '">';

              item_info +=
                '<input type="hidden" class="is_texable" id="is_texable_' +
                data.product_id +
                '" name="is_texable[' +
                data.product_id +
                ']" value="' +
                data.Applicable_Tax +
                '">';

              item_info += "<td>";

              item_info +=
                '<div class="plusMinusContainer"><span class="minus_icon reduced" data-id="' +
                data.product_id +
                '" style="position: absolute; cursor: pointer; top: 50%;    transform: translateY(-50%);    height: -webkit-fill-available;    background: red;    left: 10%;    width: 25%;"><svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 25" fill="none"><mask id="mask0" mask-type="alpha" maskUnits="userSpaceOnUse" x="5" y="11" width="14" height="3"><path fill-rule="evenodd" clip-rule="evenodd" d="M19 13.5417H5V11.4584H19V13.5417Z" fill="white"/></mask> <g mask="url(#mask0)"> <rect x="-13" y="-13.5416" width="50" height="52.0833" fill="white"/> <mask id="mask1" mask-type="alpha" maskUnits="userSpaceOnUse" x="-13" y="-14" width="50" height="53"> <rect x="-13" y="-13.5416" width="50" height="52.0833" fill="white"/> </mask><g mask="url(#mask1)"></g></g> </svg></span>';
              item_info +=
                '<input type="text" class="quantity_input" data-org_price="' +
                data.onsale_price +
                '" id="quantity_input_' +
                data.product_id +
                '" value="1" readonly style="width: 60%; border: 0px solid;background:transparent; text-align: center;font-size:1.6vw;margin:0 auto;">';
              item_info +=
                '<span class="plus_icon increase" data-id="' +
                data.product_id +
                '" style="position: absolute;cursor: pointer;top: 50%;width: 25%; height: -webkit-fill-available;right: 10%;transform: translateY(-50%);background: green;"><svg xmlns="http://www.w3.org/2000/svg" width="60%" height="-webkit-fill-available;" viewBox="0 0 24 24"><path d="M24 10h-10v-10h-4v10h-10v4h10v10h4v-10h10z" fill="white"/></svg></span>';

              item_info += "</div></td>";

              var price_strike = "";
              if (data.price > data.onsale_price) {
                // price_strike =
                //   "<br><strike style='color:red;'>$" + data.price + "</strike>";
              }

              item_info +=
                '<td class="rightTextAlign">$<span class="onsale_price_' +
                data.product_id +
                '">' +
                data.onsale_price +
                price_strike +
                "</span></td>";
              item_info += "</tr>";

              //remove row
              //<span data-productid='" + data.product_id + "' class='remove_tr'>X</span>

              $(".item_info_section").append(item_info);
              $(".table-container").scrollTop(
                $(".table-container")[0].scrollHeight
              );
              // ST - For Calculate Total
              calculatePOSTotal();
              // EN - For Calculate Total

              if ($("#exist_product_id").val() == "") {
                $("#exist_product_id").val(data.product_id);
              } else {
                var exist_product_id = $("#exist_product_id").val();
                $("#exist_product_id").val(
                  exist_product_id + "," + data.product_id
                );
              }
            }
          }
          myObj.val("");
        });
    }
    jQuery("#read_barcode_POS").focus();
    $(".table-container").scrollTop($(".table-container")[0].scrollHeight);
  });

  jQuery(document).on("change", "#misceleneous_name_change", function () {
    if ($("#is_transaction_completed").val() == 1) {
      clearTransaction();
    }

    var price = jQuery(this).val();
    var name = jQuery("#misceleneous_name_change option:selected").text();
    var tax = jQuery("#misceleneous_name_change option:selected").data("tax");

    // alert(price);
    // alert(name);
    if (price != "") {
      jQuery(".easy-numpad-output-container .secondDollarSign").css(
        "visibility",
        "visible"
      );
      jQuery("#easy-numpad-output").html(price);
      jQuery("#misceleneous_name").val(name);

      if (tax == 1) $("#taxBoolean").prop("checked", true);
      else $("#taxBoolean").prop("checked", false);
    } else {
      jQuery(".easy-numpad-output-container .secondDollarSign").css(
        "visibility",
        "hidden"
      );
      jQuery("#easy-numpad-output").html("");
      jQuery("#misceleneous_name").val("Miscellaneous");
      $("#taxBoolean").prop("checked", false);
    }
  });

  jQuery(document).on("click", ".custom_price_save", function () {
    if ($("#is_transaction_completed").val() == 1) {
      clearTransaction();
    }

    var product_id = Math.floor(Math.random() * 100 + 1);
    var misceleneous_name = jQuery("#misceleneous_name").val();
    var tax = 0;
    if (document.getElementById("taxBoolean").checked) {
      tax = 1;
    }

    var custom_price_value = get_float_value(
      jQuery("#easy-numpad-output").html()
    );

    if (custom_price_value.split(" ").join("") == "") {
      //alert("Price can not be blank.");
      swal({
        title: "Oops!",
        text: "Price can not be blank.",
        icon: "error",
        buttons: false,
        dangerMode: true,
      });
      return false;
    }

    if (misceleneous_name == "") {
      swal({
        title: "Oops!",
        text: "Name can not be blank.",
        icon: "error",
        buttons: false,
        dangerMode: true,
      });
      return false;
    }

    $.ajax({
      type: "POST",
      url: base_url + "cashier/addmisceleneous_name",
      dataType: "json",
      async: false,
      data: {
        misceleneous_name: misceleneous_name,
        custom_price_value: custom_price_value,
        tax: tax,
      },
      success: function (data) {
        //alert(data.message);
        // $("#opencalc .opencalc_close img").click();
        // return false;
      },
    });

    var item_info = "";
    item_info += '<tr id="product_tr_' + product_id + '">';
    item_info +=
      '<td style="text-align: left;padding-left: 7px;">' +
      misceleneous_name +
      "</td>";
    item_info +=
      '<input type="hidden" name="product_id[]" value="' + product_id + '">';
    item_info +=
      '<input type="hidden" name="product_name[]" value="' +
      misceleneous_name +
      '">';
    item_info +=
      '<input type="hidden" name="product_rate[]" value="' +
      custom_price_value +
      '">';
    item_info +=
      '<input type="hidden" id="product_price_' +
      product_id +
      '" name="product_price[]" value="' +
      custom_price_value +
      '">';

    item_info +=
      '<input type="hidden" id="product_offer_price_' +
      product_id +
      '" name="product_offer_price[]" value="' +
      custom_price_value +
      '">';

    item_info +=
      '<input type="hidden" id="product_qty_' +
      product_id +
      '" name="product_qty[]" value="1">';

    item_info +=
      '<input type="hidden" id="product_crv_' +
      product_id +
      '" name="product_crv[]" value="0">';

    item_info +=
      '<input type="hidden" id="is_product_crv_' +
      product_id +
      '" name="is_product_crv[]" value="0">';

    item_info +=
      '<input type="hidden" id="is_product_size_' +
      product_id +
      '" name="is_product_size[]" value="0">';

    item_info +=
      '<input type="hidden" class="is_texable" id="is_texable_' +
      product_id +
      '" name="is_texable[' +
      product_id +
      ']" value="' +
      tax +
      '">';

    item_info += "<td>";
    item_info +=
      '<div class="plusMinusContainer"><span class="minus_icon reduced" data-id="' +
      product_id +
      '"  style="position: absolute; cursor: pointer; top: 50%;    transform: translateY(-50%);    height: -webkit-fill-available;    background: red;    left: 10%;    width: 25%;"><svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 25" fill="none"><mask id="mask0" mask-type="alpha" maskUnits="userSpaceOnUse" x="5" y="11" width="14" height="3"><path fill-rule="evenodd" clip-rule="evenodd" d="M19 13.5417H5V11.4584H19V13.5417Z" fill="white"/></mask> <g mask="url(#mask0)"> <rect x="-13" y="-13.5416" width="50" height="52.0833" fill="white"/> <mask id="mask1" mask-type="alpha" maskUnits="userSpaceOnUse" x="-13" y="-14" width="50" height="53"> <rect x="-13" y="-13.5416" width="50" height="52.0833" fill="white"/> </mask><g mask="url(#mask1)"></g></g> </svg></span>';
    item_info +=
      '<input type="text" class="quantity_input" data-org_price="' +
      custom_price_value +
      '" id="quantity_input_' +
      product_id +
      '" value="1" readonly style="width: 60%;   border: 0px solid;background: transparent; text-align: center; font-size: 1.6vw;  margin: 0 auto;">';
    item_info +=
      '<span class="plus_icon increase" data-id="' +
      product_id +
      '" style="position: absolute;cursor: pointer;top: 50%;width: 25%; height: -webkit-fill-available;right: 10%;transform: translateY(-50%);background: green;"><svg xmlns="http://www.w3.org/2000/svg" width="60%" height="-webkit-fill-available;" viewBox="0 0 24 24"><path d="M24 10h-10v-10h-4v10h-10v4h10v10h4v-10h10z" fill="white"/></svg></span>';
    item_info += "</td>";

    item_info +=
      '<td class="rightTextAlign">$<span class="onsale_price_' +
      product_id +
      '">' +
      custom_price_value +
      "</span></div> </td>";
    item_info += "</tr>";

    //remove code
    //<span data-productid='" + product_id + "' class='remove_tr'>X</span>

    $(".item_info_section").append(item_info);
    jQuery("#read_barcode_POS").focus();
    // ST - For Calculate Total
    calculatePOSTotal();
    // EN - For Calculate Total

    jQuery("#easy-numpad-output").html("");
    jQuery("#misceleneous_name").val("Miscellaneous");

    $("#epa img").click();

    jQuery("#read_barcode_POS").focus();
  });

  Array.prototype.remove = function () {
    var what,
      a = arguments,
      L = a.length,
      ax;
    while (L && this.length) {
      what = a[--L];
      while ((ax = this.indexOf(what)) !== -1) {
        this.splice(ax, 1);
      }
    }
    return this;
  };

  jQuery(document).on("click", ".remove_tr", function () {
    var product_id = $(this).data("productid");

    //3S346QHZ,JZ6VEFVS

    var exist_product_id_arr = $("#exist_product_id").val().split(",");
    exist_product_id_arr.remove(product_id);
    jQuery("#exist_product_id").val(exist_product_id_arr.join(","));
    jQuery("#product_tr_" + product_id).remove();
    calculatePOSTotal();
  });

  jQuery(document).on("click", ".misceleneous_item", function () {
    if ($("#is_transaction_completed").val() == 1) {
      clearTransaction();
    }

    var product_id = Math.floor(Math.random() * 100 + 1);
    var misceleneous_name = jQuery(this).attr("data-productname");
    var custom_price_value = jQuery(this).attr("data-productprice");

    var product_id = $(this).attr("data-product_id");

    var exist_product_id_arr = $("#exist_product_id").val().split(",");
    if (jQuery.inArray(product_id, exist_product_id_arr) !== -1) {
      // Exist

      $(".increase[data-id=" + product_id + "]").trigger("click");
    } else {
      var product_id = Math.floor(Math.random() * 100 + 1);
      $(this).attr("data-product_id", product_id);

      if ($("#exist_product_id").val() == "") {
        $("#exist_product_id").val(product_id);
      } else {
        var exist_product_id = $("#exist_product_id").val();
        $("#exist_product_id").val(exist_product_id + "," + product_id);
      }

      //var custom_price_value = get_float_value(custom_price_value);

      if (custom_price_value.split(" ").join("") == "") {
        swal({
          title: "Oops!",
          text: "Price can not be blank.",
          icon: "error",
          buttons: false,
          dangerMode: true,
        });
        return false;
      }

      if (misceleneous_name == "") {
        swal({
          title: "Oops!",
          text: "Name can not be blank.",
          icon: "error",
          buttons: false,
          dangerMode: true,
        });
        return false;
      }

      var item_info = "";
      item_info += '<tr id="product_tr_' + product_id + '">';
      item_info +=
        '<td style="text-align: left;padding-left: 7px;">' +
        misceleneous_name +
        "</td>";
      item_info +=
        '<input type="hidden" name="product_id[]" value="' + product_id + '">';
      item_info +=
        '<input type="hidden" name="product_name[]" value="' +
        misceleneous_name +
        '">';
      item_info +=
        '<input type="hidden" name="product_rate[]" value="' +
        custom_price_value +
        '">';
      item_info +=
        '<input type="hidden" id="product_price_' +
        product_id +
        '" name="product_price[]" value="' +
        custom_price_value +
        '">';

      item_info +=
        '<input type="hidden" id="product_offer_price_' +
        product_id +
        '" name="product_offer_price[]" value="' +
        custom_price_value +
        '">';

      item_info +=
        '<input type="hidden" id="product_qty_' +
        product_id +
        '" name="product_qty[]" value="1">';

      item_info +=
        '<input type="hidden" id="product_crv_' +
        product_id +
        '" name="product_crv[]" value="0">';

      item_info +=
        '<input type="hidden" id="is_product_crv_' +
        product_id +
        '" name="is_product_crv[]" value="0">';

      item_info +=
        '<input type="hidden" id="is_product_size_' +
        product_id +
        '" name="is_product_size[]" value="0">';

      /*item_info += "<td>";
        item_info +=
          '<input type="checkbox" style="height:20px;width:20px" class="is_texable" id="is_texable_' +
          product_id +
          '" name="is_texable[' +
          product_id +
          ']" value="1">';
        item_info += "</td>";*/

      item_info += "<td>";
      item_info +=
        '<div class="plusMinusContainer"><span class="minus_icon reduced" data-id="' +
        product_id +
        '" style="position: absolute; cursor: pointer; top: 50%;    transform: translateY(-50%);    height: -webkit-fill-available;    background: red;    left: 10%;    width: 25%;"><svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 25" fill="none"><mask id="mask0" mask-type="alpha" maskUnits="userSpaceOnUse" x="5" y="11" width="14" height="3"><path fill-rule="evenodd" clip-rule="evenodd" d="M19 13.5417H5V11.4584H19V13.5417Z" fill="white"/></mask> <g mask="url(#mask0)"> <rect x="-13" y="-13.5416" width="50" height="52.0833" fill="white"/> <mask id="mask1" mask-type="alpha" maskUnits="userSpaceOnUse" x="-13" y="-14" width="50" height="53"> <rect x="-13" y="-13.5416" width="50" height="52.0833" fill="white"/> </mask><g mask="url(#mask1)"></g></g> </svg></span>';
      item_info +=
        '<input type="text" class="quantity_input" data-org_price="' +
        custom_price_value +
        '" id="quantity_input_' +
        product_id +
        '" value="1" readonly style="width: 60%;   border: 0px solid;background: transparent; text-align: center; font-size: 1.6vw;font-size: 1.6vw;  margin: 0 auto;">';
      item_info +=
        '<span class="plus_icon increase" data-id="' +
        product_id +
        '" style="position: absolute;cursor: pointer;top: 50%;width: 25%; height: -webkit-fill-available;right: 10%;transform: translateY(-50%);background: green;"><svg xmlns="http://www.w3.org/2000/svg" width="60%" height="100%" viewBox="0 0 24 24"><path d="M24 10h-10v-10h-4v10h-10v4h10v10h4v-10h10z" fill="white"/></svg></span>';
      item_info += "</td>";

      item_info +=
        '<td class="rightTextAlign">$<span class="onsale_price_' +
        product_id +
        '">' +
        custom_price_value +
        "</span></div></td>";
      item_info += "</tr>";

      $(".item_info_section").append(item_info);
    }

    // ST - For Calculate Total
    calculatePOSTotal();
    // EN - For Calculate Total

    // jQuery("#easy-numpad-output").html("");
    // jQuery("#misceleneous_name").val("");

    $("#epa img").click();
    jQuery("#read_barcode_POS").focus();
  });

  jQuery(document).on("click", ".reduced", function () {
    var product_id = $(this).attr("data-id");
    var quantity = $("#quantity_input_" + product_id).val();
    var org_price = $("#quantity_input_" + product_id).attr("data-org_price");

    var Applicable_CRV = $("#is_product_crv_" + product_id).val();
    var is_product_size = $("#is_product_size_" + product_id).val();

    if (quantity > 1) {
      quantity--;
      $("#quantity_input_" + product_id).val(quantity);

      var offer_price = $("#product_offer_price_" + product_id).val();

      // if(org_price > offer_price) {
      //     var new_sale_price = parseFloat(offer_price) * parseFloat(quantity);
      // } else {
      //     var new_sale_price = parseFloat(org_price) * parseFloat(quantity);
      // }

      var new_sale_price = parseFloat(org_price) * parseFloat(quantity);
      //var new_sale_price = parseFloat(org_price) * parseFloat(quantity);
      $(".onsale_price_" + product_id).html(new_sale_price.toFixed(2));
      $("#product_price_" + product_id).val(new_sale_price.toFixed(2));
      $("#product_qty_" + product_id).val(quantity);

      var crv_oz = 0;
      var crv_rate = 0;
      var crv_price = 0;
      if (Applicable_CRV == 1) {
        var str2 = "oz";
        if (is_product_size.indexOf(str2) != -1) {
          is_product_size = is_product_size.replace("oz", "");
          is_product_size = is_product_size.replace(" ", "");

          crv_oz = parseFloat(is_product_size);
          if (crv_oz >= 23.99) {
            crv_price = 0.1 * quantity;
          } else {
            crv_price = 0.05 * quantity;
          }
        }
      }
      $("#product_crv_" + product_id).val(parseFloat(crv_price));

      calculatePOSTotal();
    } else {
      swal({
        title: "Are you sure wants to delete this product? ",
        //text: "Once deleted, you will not be able to recover this imaginary file!",
        icon: "warning",
        buttons: true,
        dangerMode: true,
      }).then((willDelete) => {
        if (willDelete) {
          $("#product_tr_" + product_id).remove();
          var exist_product_id_arr = $("#exist_product_id").val().split(",");
          exist_product_id_arr.remove(product_id);
          jQuery("#exist_product_id").val(exist_product_id_arr.join(","));
          calculatePOSTotal();
          swal("Product has been deleted..!", {
            icon: "success",
            buttons: false,
            timer: 2000,
          });
        }
        // else {
        //   swal("Your imaginary file is safe!");
        // }
      });

      // $("#product_tr_" + product_id).remove();
      // var exist_product_id_arr = $("#exist_product_id").val().split(",");
      // exist_product_id_arr.remove(product_id);
      // jQuery("#exist_product_id").val(exist_product_id_arr.join(","));
      // calculatePOSTotal();
    }
  });

  jQuery(document).on("click", ".increase", function () {
    var product_id = $(this).attr("data-id");
    var org_price = $("#quantity_input_" + product_id).attr("data-org_price");
    var quantity = $("#quantity_input_" + product_id).val();
    quantity++;
    $("#quantity_input_" + product_id).val(quantity);

    var offer_price = $("#product_offer_price_" + product_id).val();

    // if(org_price > offer_price) {
    //     var new_sale_price = parseFloat(offer_price) * parseFloat(quantity);
    // } else {
    //     var new_sale_price = parseFloat(org_price) * parseFloat(quantity);
    // }

    var new_sale_price = parseFloat(org_price) * parseFloat(quantity);
    // var new_sale_price = parseFloat(org_price) * parseFloat(quantity);
    $(".onsale_price_" + product_id).html(new_sale_price.toFixed(2));
    $("#product_price_" + product_id).val(new_sale_price.toFixed(2));
    $("#product_offer_price_" + product_id).val(new_sale_price.toFixed(2));

    //$("#product_offer_price_" + product_id).val();

    $("#product_qty_" + product_id).val(quantity);
    var Applicable_CRV = $("#is_product_crv_" + product_id).val();
    var is_product_size = $("#is_product_size_" + product_id).val();

    var crv_oz = 0;
    var crv_rate = 0;
    var crv_price = 0;
    if (Applicable_CRV == 1) {
      var str2 = "oz";
      if (is_product_size.indexOf(str2) != -1) {
        is_product_size = is_product_size.replace("oz", "");
        is_product_size = is_product_size.replace(" ", "");

        crv_oz = parseFloat(is_product_size);
        if (crv_oz >= 23.99) {
          crv_price = 0.1 * quantity;
        } else {
          crv_price = 0.05 * quantity;
        }
      }
    }
    $("#product_crv_" + product_id).val(parseFloat(crv_price));

    calculatePOSTotal();
  });

  jQuery(document).on("click", "#del2", function (e) {
    e.preventDefault();

    var return_bal = $("#return_balance_html").html();
    var optxt = $("#optxt").html();

    if (optxt == "") {
      alert("Please enter amount");
      return false;
    }

    if (parseFloat(return_bal) < 0) {
      alert("Tendered cash is less than billed amount");
      return false;
    }
    $("#db_return_balance").val(parseFloat(return_bal));
    var data = $("#frmItemCart").serializeArray();
    $.ajax({
      type: "POST",
      url: base_url + "cashier/POSterminalCheckout",
      dataType: "json",
      async: false,
      data: data,
      success: function (data) {
        //alert(data.message);
        $("#opencalc .opencalc_close img").click();

        $(
          "#transaction_type,#transaction_status,#transaction_return_balance,#tendered_amt"
        ).show();
        $("#transaction_return_balance_html").html("$" + return_bal);

        var return_balance_html = parseFloat($("#return_balance_html").html());
        var grand_total = parseFloat($("#cart_grand_total").val());
        var transaction_tendered = return_balance_html + grand_total;
        $("#transaction_tendered").html("$" + transaction_tendered.toFixed(2));

        $("#is_transaction_completed").val("1");
        doPrintReceipt(data.order_id);
        return false;

        //window.open(base_url + "cashier/pos_rcpt/"+data.order_id,'_blank');
        //return false;
      },
    });
    document.getElementById("optxt").innerHTML = "";
  });

  // jQuery(document).on("click", ".is_texable", function (e) {
  //   calculatePOSTotal();
  // });
});

function doPrintReceipt(ord_id) {
  // $.addPanels(base_url + "cashier/pos_rcpt/"+ord_id);

  $.ajax({
    type: "POST",
    url: base_url + "cashier/pos_rcpt/" + ord_id,
    dataType: "html",
    async: false,
    success: function (data) {
      var fileContents = data;

      var popupWinindow = window.open(
        "",
        "_blank",
        "width=600,height=700,scrollbars=no,menubar=no,toolbar=no,location=no,status=no,titlebar=no"
      );
      popupWinindow.document.open();
      popupWinindow.document.write(fileContents);
      popupWinindow.document.close();
    },
  });
}

function checkValidNumber(ent) {
  var val = window.event ? ent.keyCode : ent.which;
  //alert(val);
  if (val < 48 && val != "46" && val != 13)
    // Allow Enter Key
    window.event ? (ent.keyCode = 0) : (ent.which = 0);

  if (val > 57) return false;

  return true;
}

function calculatePOSTotal() {
  var sub_total = 0.0;
  var taxable_total = 0.0;
  var crv = 0.0;
  $("input[name='product_price[]']").each(function (e) {
    var product_id_arr = $(this).attr("id").split("product_price_");
    var product_id = product_id_arr[1];

    var pro_crv = $("#product_crv_" + product_id).val();
    crv += parseFloat(pro_crv);

    var price = $(this).val();
    var offer_price = $("#product_offer_price_" + product_id).val();

    // if(price > offer_price) {

    //     sub_total = parseFloat(sub_total) + parseFloat(offer_price);

    // } else {

    //     sub_total = parseFloat(sub_total) + parseFloat($(this).val());
    // }

    sub_total = parseFloat(sub_total) + parseFloat($(this).val());

    if (jQuery("#is_texable_" + product_id).val() == 1) {
      taxable_total = parseFloat(taxable_total) + parseFloat($(this).val());
    }
  });

  var sub_total_disp = sub_total.toFixed(2);
  var sub_total_taxable_disp = taxable_total.toFixed(2);
  crv = parseFloat(crv);

  $("#sub_total").html("$" + sub_total_disp);

  var tax = 7.75;
  var tax_calculate = (sub_total_taxable_disp * tax) / 100;
  var grand_total =
    parseFloat(sub_total_disp) + parseFloat(tax_calculate) + parseFloat(crv);

  var grand_total_disp = grand_total.toFixed(2);
  $("#tax_html").html("$" + parseFloat(tax_calculate).toFixed(2));
  $("#tax_amount").val(parseFloat(tax_calculate).toFixed(2));
  $("#CRV_box").html(parseFloat(crv).toFixed(2));
  $("#container_deposit").val(parseFloat(crv).toFixed(2));
  $("#grand_total").html("$" + grand_total_disp);
  $("#cart_grand_total").val(grand_total_disp);
}

jQuery(document).on("click", ".search_mobile_number", function (e) {
  var customer_mobile_no = $("#customer_mobile_no").val();
  $.ajax({
    type: "POST",
    url: base_url + "cashier/getcustomerByPhone",
    dataType: "json",
    async: false,
    data: {
      customer_mobile_no: customer_mobile_no,
    },
    success: function (data) {
      if (data.status == "success") {
        var customer_name = data.data.customer_name;
        var customer_id = data.data.customer_id;

        $(".pos-head").html(customer_name);
        $(".pos-head").css("color", "#000");
        $(".walk_in_customer_modal_close img").trigger("click");
        $("#walk_in_customer_name").val(customer_name);
        $("#walk_in_customer_id").val(customer_id);

        // $("#opencalc .opencalc_close img").click();
      }
      // $("#opencalc .opencalc_close img").click();
      // return false;
    },
  });
});

function formatPhoneNumber(phoneNumberString) {
  var cleaned = ("" + phoneNumberString).replace(/\D/g, "");
  var match = cleaned.match(/^(\d{3})(\d{3})(\d{4})$/);
  if (match) {
    return "(" + match[1] + ") " + match[2] + "-" + match[3];
  }
  return null;
}

function clearTransaction() {
  $(".item_info_section tr").remove();
  $(
    "#exist_product_id,#cart_grand_total,#container_deposit,#db_return_balance,#tax_amount"
  ).val("");
  $("#walk_in_customer_id,#is_transaction_completed").val("0");
  $("#walk_in_customer_name").val("Walk-in Customer");
  $(
    "#sub_total,#tax_html,#grand_total,#transaction_return_balance_html,#transaction_tendered"
  ).html("$0.00");
  $("#CRV_box").html("0.00");
  $(
    "#transaction_type,#transaction_status,#transaction_return_balance,#tendered_amt"
  ).hide();
}
